{% extends "shared/layout.html" %}

{% block title %}Discover Recipes{% endblock %}

{% block content %}

<style>
    .input-group {
        width: 60%;
        margin: 20px auto;
    }

    .table {
        width: 80%;
        margin: 20px auto;
    }

    .table th,
    .table td {
        vertical-align: middle;
    }

    .add-button {
        position: absolute;
        right: 20px;
    }

    .step-input {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .step-input input {
        flex: 1;
        margin-right: 10px;
    }
</style>

<div class="container-fluid" style="width: 80%;">
    <div class="container-fluid text-center">
        <h2>Recipes</h2>
        <div class="row">
            <div class="col">
                <div class="input-group mb-3">
                    <input id="searchRecipes" class="form-control" type="text" placeholder="Search Recipes..">
                    {% if user_logged_in %}
                    <a class="btn btn-dark ml-1" href="{{url_for('create_recipe')}}"><i class="fas fa-plus"></i> Add Recipe
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid text-center">
        <table id="recipeTable" class="table table-bordered table-hover">
            <thead class="thead-dark">
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th>Created By</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for recipe in recipes %}
            <tr>
                <td>{{ recipe.recipeName }}</td>
                <td>{{ recipe.description }}</td>
                <td>{{ recipe.username }}</td>
                <td>
                    <a href="{{ url_for('get_recipe_details', recipe_id=recipe.recipeID) }}"
                       class="btn btn-primary btn-sm">More Details</a>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Search By Ingredients Form -->
    <div class="container-fluid text-center mt-5 pt-5">
        <h2>Search By Ingredients</h2>
        <form action="{{ url_for('search_by_ingredient') }}" method="POST">
            <div class="form-group">
                <label for="searchIngredients">Enter Ingredients (comma separated)</label>
                <textarea id="searchIngredients" class="form-control" name="ingredients" rows="4"
                          placeholder="Enter ingredients here..."></textarea>
            </div>

            <div class="form-check">
                <input class="form-check-input" type="radio" name="search_option" id="only_listed" value="only_listed"
                       checked>
                <label class="form-check-label" for="only_listed">
                    Only Ingredients Listed
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="search_option" id="with_more" value="with_more">
                <label class="form-check-label" for="with_more">
                    Ingredients Listed and More
                </label>
            </div>

            <button class="btn btn-dark mt-3" type="submit">Search</button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Search functionality
        const searchRecipeInput = document.getElementById('searchRecipes');
        const tableRecipeRows = document.querySelectorAll('#recipeTable tbody tr');

        searchRecipeInput.addEventListener('input', function () {
            const searchTerm = searchRecipeInput.value.toLowerCase().trim();

            tableRecipeRows.forEach(row => {
                const title = row.cells[0].textContent.toLowerCase();
                const description = row.cells[1].textContent.toLowerCase();
                const created_by = row.cells[2].textContent.toLowerCase();

                if (title.includes(searchTerm) || description.includes(searchTerm) || created_by.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        const searchIngredientInput = document.getElementById('searchIngredients');
        const tableIngredientRows = document.querySelectorAll('#ingredientTable tbody tr');

        searchIngredientInput.addEventListener('input', function () {
            const searchTerm = searchIngredientInput.value.toLowerCase().trim();

            tableIngredientRows.forEach(row => {
                const ingredientName = row.cells[0].textContent.toLowerCase();

                if (ingredientName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });


        // Add Step functionality
        const stepsContainer = document.getElementById('stepsContainer');
        const addStepButton = document.getElementById('addStepButton');

        addStepButton.addEventListener('click', function () {
            const stepCount = stepsContainer.children.length + 1;
            const stepDiv = document.createElement('div');
            stepDiv.className = 'step-input';
            stepDiv.innerHTML = `
                <input type="text" class="form-control" name="steps[]" placeholder="Step ${stepCount}" required>
                <button type="button" class="btn btn-danger remove-step-button">&times;</button>
            `;
            stepsContainer.appendChild(stepDiv);
        });

        stepsContainer.addEventListener('click', function (event) {
            if (event.target.classList.contains('remove-step-button')) {
                event.target.parentElement.remove();
            }
        });

    });
</script>
{% endblock %}