{% extends "shared/layout.html" %}

{% block title %}My Recipes{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2>My Recipes</h2>

    <!-- Search Form -->
    <form class="form-inline mb-3" method="POST" action="{{ url_for('my_recipes') }}">
        <div class="form-row">
            <div class="col-auto">
                <input type="text" class="form-control" name="search_term" style="min-width: 300px; width: auto;"
                       placeholder="Search by name or description"
                       aria-label="search" value="{{ search_term }}">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-outline-success ml-1">Search</button>
            </div>
        </div>
    </form>

    {% if total_count == 0 %}
    <div class="container-fluid">
        No recipes found.
    </div>
    {% else %}
    <table class="table table-bordered table-hover">
        <thead class="thead-dark">
        <tr>
            <th>Name</th>
            <th>Description</th>
            <th>Rating</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
    {% endif %}
</div>

<!-- Delete Recipe Modal -->
<div class="modal fade" id="deleteRecipeModal" tabindex="-1" role="dialog" aria-labelledby="deleteRecipeModalLabel"
     aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteRecipeModalTitle">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this recipe? This is an irreversible action.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <form id="deleteRecipeForm" method="post">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function () {
        $('#recipeTable').DataTable({
            "processing": true,
            "serverSide": true,
            "ajax": {
                "url": "{{ url_for('my_recipes') }}",
                "type": "POST",
                "data": function (d) {
                    d.search_term = $('input[name=search_term]').val();
                }
            },
            "columns": [
                {"data": "recipeName"},
                {"data": "description"},
                {
                    "data": "averageRating", "render": function (data, type, row) {
                        return data ? data + ' (' + row.ratingCount + ')' : 'Not rated';
                    }
                },
                {
                    "data": null, "render": function (data, type, row) {
                        return '<a href="/recipes/' + row.recipeID + '" class="btn btn-info btn-sm">View</a> ' +
                            '<a href="/editRecipe/' + row.recipeID + '" class="btn btn-warning btn-sm">Edit</a> ' +
                            '<form action="/deleteRecipe/' + row.recipeID + '" method="post" style="display:inline;">' +
                            '<button type="submit" class="btn btn-danger btn-sm" onclick="showDeleteRecipeModal(' + row.recipeID + '">Delete</button>' +
                            '</form>';
                    }
                }
            ],
            "order": []
        });
    });
</script>

<!-- Confirm Delete Recipe Script -->
<script>
    function showDeleteRecipeModal(recipeID) {
        const form = document.getElementById('deleteRecipeForm');
        form.action = '/delete/' + recipeID;
        $('#deleteRecipeModal').modal('show');
    }
</script>
{% endblock %}